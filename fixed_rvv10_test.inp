&GLOBAL
  PROJECT fixed_rvv10_test
  RUN_TYPE ENERGY
  PRINT_LEVEL MEDIUM
&END GLOBAL

&FORCE_EVAL
  METHOD Quickstep
  &DFT
    BASIS_SET_FILE_NAME BASIS_MOLOPT
    POTENTIAL_FILE_NAME GTH_POTENTIALS
    
    &MGRID
      CUTOFF 400
      REL_CUTOFF 50
    &END MGRID
    
    &QS
      METHOD GPW
      EPS_DEFAULT 1.0E-10
    &END QS
    
    &SCF
      SCF_GUESS ATOMIC
      MAX_SCF 100
      EPS_SCF 1.0E-6
      IGNORE_CONVERGENCE_FAILURE
      
      &OT
        MINIMIZER CG
        PRECONDITIONER FULL_SINGLE_INVERSE
        ENERGY_GAP 0.1
      &END OT
    &END SCF
    
    ! 修复的PBE+rVV10设置
    &XC
      &XC_FUNCTIONAL
        &PBE
          SCALE_X 1.0
          SCALE_C 1.0
        &END PBE
      &END XC_FUNCTIONAL
      
      ! 正确的rVV10设置，使用论文参数
      &vdW_POTENTIAL
        DISPERSION_FUNCTIONAL NON_LOCAL
        &NON_LOCAL
          TYPE RVV10
          VERBOSE_OUTPUT
          KERNEL_FILE_NAME /opt/homebrew/Cellar/cp2k/2025.1/share/cp2k/data/vdW_kernel_table.dat
          CUTOFF 20.0
          &RVV10
            BH 6.3  ! 或使用 7.8，论文中的 b 参数
            B 0.0093
          &END RVV10
        &END NON_LOCAL
      &END vdW_POTENTIAL
    &END XC
    
    &PRINT
      &MO
        EIGENVALUES
        OCCUPATION_NUMBERS
        &EACH
          QS_SCF 0
        &END EACH
      &END MO
    &END PRINT
  &END DFT
  
  &SUBSYS
    &CELL
      ABC 12.0 12.0 12.0
      PERIODIC NONE
    &END CELL
    
    ! 使用简单的C2分子测试
    &COORD
C   0.000000   0.000000   0.000000
C   1.420000   0.000000   0.000000
    &END COORD
    
    &KIND C
      BASIS_SET DZVP-MOLOPT-GTH-q4
      POTENTIAL GTH-PBE-q4
    &END KIND
  &END SUBSYS
&END FORCE_EVAL
